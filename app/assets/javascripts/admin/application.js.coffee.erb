//= require jquery
//= require jquery_ujs
//= require jquery-ui/sortable
//= require jquery-ui/droppable
//= require jquery-ui/effect.all
//= require underscore
//= require twitter/bootstrap
//= require select2/select2
//= require select2/select2_locale_ru
//= require jquery.scrollTo/jquery.scrollTo
//= require tabs_memory
//= require ./search-box
//= require ./transliterate
//= require ./destroy_helper
//= require ./sort
//= require ./products
//= require ./category
//= require react
//= require tinymce
//= require plupload/js/plupload.full.min
//= require ./file_uploader

$ ->
  $(document).ajaxComplete (event, request) ->
    try
      data = JSON.parse request.responseText
      if data.flash
        $('#content').prepend(data.flash)
        $('.flash-message').delay(5000).slideUp()
    catch e

  $('.flash-message').delay(5000).slideUp()

  $('ul.nav.bs-sidenav > li > a').click (e) ->
    if $(this).next('ul.nav').length
      $(this).next('ul.nav').slideToggle()
      e.preventDefault()

  $('select').select2(allowClear: true)

  $('a.top').click (e) ->
    e.preventDefault()
    $('html, body').animate scrollTop: 0, 300

  $('.transliterate').click (e) ->
    val = transliterate($($(this).data('source')).val())
    val = val.replace /^\s+|\s+$/g, ''
    val = val.replace /\s+/g, '-'
    val = val.replace /\-+/g, '-'
    val = val.replace /[^A-z0-9\-]/g, ''
    $($(this).data('target')).val val.toLowerCase()
    e.preventDefault()

  $('.tags').select2(
    width: -> $(this.element.context).data('width')
    tags: true
    tokenSeparators: [",", ", "]
    initSelection: (element, callback) ->
      data = [];
      $(element.val().split(",")).each( ->
        data.push(id: this, text: this)
      )
      callback data
    createSearchChoice: (term, data) ->
      if $(data).filter(-> this.text.localeCompare(term) == 0).length == 0
        id: term
        text: term
    multiple: true
    ajax:
      url: (element) ->
        $(this).data('autocomplete-url')
      dataType: 'json'
      data: (term, page) ->
        q: term
      results: (data, page) ->
        results = []
        $.each(data, (index, item) ->
          results.push(
            id: item.name,
            text: item.name
          )
        )
        results: results
  )

  # fix: really remove element from input
  $('.tags').on('select2-removed', (e) ->
    fixedValue = $(this).attr('value')
    removedStr = $.trim e.val.toString()
    for num in [0..1]
      fixedValue = fixedValue.replace(new RegExp("#{removedStr}(,|$)"), '')
    $(this).attr 'value', fixedValue
    $(this).val fixedValue
  )
